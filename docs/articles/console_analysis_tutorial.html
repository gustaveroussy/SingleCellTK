<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SingleCellTK - Console Analysis Tutorial • singleCellTK</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="SingleCellTK - Console Analysis Tutorial">
<meta property="og:description" content="singleCellTK">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">singleCellTK</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="https://www.camplab.net/sctk" class="external-link">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/console_analysis_tutorial.html">A La Carte Workflow - PBMC3K (R Console)</a>
    </li>
    <li>
      <a href="../articles/cnsl_seurat_curated_workflow.html">Seurat Curated Workflow - PBMC3K</a>
    </li>
    <li>
      <a href="../articles/celda_curated_workflow.html">Celda Curated Workflow - PBMC3K</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cmd_qc.html">SCTK-QC</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Documentation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Data</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/import_data.html">Import Data</a>
        </li>
        <li>
          <a href="../articles/import_genesets.html">Import Gene Sets</a>
        </li>
        <li>
          <a href="../articles/import_annotation.html">Annotation</a>
        </li>
        <li>
          <a href="../articles/export_data.html">Export Data</a>
        </li>
        <li>
          <a href="../articles/delete_data.html">Delete Data</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QC &amp; Filtering</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/cnsl_dropletqc.html">Droplet QC (R console)</a>
        </li>
        <li>
          <a href="../articles/cnsl_cellqc.html">Cell QC (R console)</a>
        </li>
        <li>
          <a href="../articles/ui_qc.html">Cell QC (Shiny UI)</a>
        </li>
        <li>
          <a href="../articles/filtering.html">Filtering</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Normalization &amp; Batch Correction</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/cnsl_normalization.html">Normalization</a>
        </li>
        <li>
          <a href="../articles/batch_correction.html">Batch Correction</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Feature Selection &amp; Dimensionality Reduction</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/cnsl_feature_selection.html">Feature Selection</a>
        </li>
        <li>
          <a href="../articles/cnsl_dimensionality_reduction.html">Dimensionality Reduction</a>
        </li>
        <li>
          <a href="../articles/cnsl_2d_embedding.html">2D Embedding</a>
        </li>
      </ul>
</li>
    <li>
      <a href="../articles/clustering.html">Clustering</a>
    </li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Differential Expression &amp; Cell Type Labeling</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/differential_expression.html">Differential Expression</a>
        </li>
        <li>
          <a href="../articles/find_marker.html">Find Marker</a>
        </li>
        <li>
          <a href="../articles/cell_type_labeling.html">Cell Type Labeling</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Enrichment &amp; Pathway Analysis</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/cnsl_enrichR.html">EnrichR</a>
        </li>
        <li>
          <a href="../articles/pathwayAnalysis.html">Pathway Analysis</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Curated Workflows</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/cnsl_seurat_curated_workflow.html">Seurat</a>
        </li>
        <li>
          <a href="../articles/celda_curated_workflow.html">Celda</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Visualization</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/visualization.html">General Visualization</a>
        </li>
        <li>
          <a href="../articles/heatmap.html">Generic Heatmap</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">NEWS</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/compbiomed/singleCellTK" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/camplab1" class="external-link">
    <span class="fab fa-twitter fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SingleCellTK - Console Analysis Tutorial</h1>
                        <h4 data-toc-skip class="author">Yichen Wang</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/compbiomed/singleCellTK/blob/HEAD/vignettes/articles/console_analysis_tutorial.Rmd" class="external-link"><code>vignettes/articles/console_analysis_tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>console_analysis_tutorial.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Single Cell Toolkit (singleCellTK, SCTK) is a package that works on single-cell RNA-seq (scRNAseq) dataset. SCTK allows users to import multiple datasets, perform quality control and a series of preprocessing, get clustering on cells and markers of clusters, and run various downstream analysis. Meanwhile, SCTK also wraps curated workflows for <a href="https://celda.camplab.net/v1.9.2/index.html" class="external-link">celda</a> and <a href="https://satijalab.org/seurat/" class="external-link">Seurat</a>.</p>
<p>This tutorial will take the real-world scRNAseq dataset as an example, which consists of 2,700 Peripheral Blood Mononuclear Cells (PBMCs) collected from a healthy donor. This dataset (PBMC3K) is available from 10X Genomics and can be found on the 10X website.</p>
<p>SCTK uses the <a href="https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a> (SCE) object for management of expression matrices, feature/cell annotation data, and metadata. All of the functions have an SCE object as the first input parameter. The functions operate on a matrix stored in the <code>assay</code> slot of the SCE object. The parameter <code>useAssay</code> can be used to specify which matrix to use (the default is <code>"counts"</code>). Matrices can be of class <code>matrix</code> or <code>dgCMatrix</code> from the Matrix package.</p>
</div>
<div class="section level2">
<h2 id="import-data">Import Data<a class="anchor" aria-label="anchor" href="#import-data"></a>
</h2>
<p>SCTK has wrapper functions for importing count matrix from the output of many types of processing tools. See the <a href="import_data.html">documentation for importing data</a> for more detail. Here we use <code><a href="../reference/importExampleData.html">importExampleData()</a></code> to load PBMC3k data from the Bioconductor package <a href="https://bioconductor.org/packages/release/data/experiment/html/TENxPBMCData.html" class="external-link">TENxPBMCData</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.camplab.net/sctk/" class="external-link">singleCellTK</a></span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importExampleData.html">importExampleData</a></span><span class="op">(</span><span class="st">"pbmc3k"</span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="importing-cellranger-output-data">Importing CellRanger Output Data<a class="anchor" aria-label="anchor" href="#importing-cellranger-output-data"></a>
</h3>
<p>Here, we briefly introduce the approach to importing the output of the widely used preprocessing tool, <code>cellranger</code>. SCTK has a generic function <code><a href="../reference/importCellRanger.html">importCellRanger()</a></code> for this purpose, and, explicitly, <code><a href="../reference/importCellRanger.html">importCellRangerV2()</a></code> and <code><a href="../reference/importCellRanger.html">importCellRangerV3()</a></code> for different versions of <code>cellranger</code>. For the detail of these functions, please click on the function names to be redirected to the reference page.</p>
<p>The input arguments basically asks users what the exact paths of the input data files are (i.e. <code>"matrix.mtx"</code>, <code>"features.tsv"</code>, and <code>"barcodes.tsv"</code>). They are <code>cellRangerDirs</code>, <code>sampleDirs</code>, <code>cellRangerOuts</code>, <code>matrixFileNames</code>, <code>featuresFileNames</code> and <code>barcodesFileNames</code>. And the function will identify the specified path, for example, of the barcode file, as a combination of: <code>{cellRangerDirs}/{sampleDirs}/{cellRangerOuts}/{barcodesFileNames}</code>. Theses functions automatically try to recognize a preset substucture of <code>cellRangerDirs</code>, so that in most of the cases, users only need to specify <code>cellRangerDirs</code> to tell where the top level directory of the output is. However, sometimes the three essential files may be placed or named in a different way and the default detection method won’t find them. In this case, users will need to check the exact paths and manually specify the correct input according to the combination rule above and the error messages.</p>
<p>An example folder structure:</p>
<pre><code><span class="va">.</span><span class="op">/</span><span class="va">datasets</span><span class="op">/</span>
    <span class="va">sample1</span><span class="op">/</span>
        <span class="va">outs</span><span class="op">/</span><span class="va">filtered_feature_bc_matrix</span><span class="op">/</span>
            <span class="va">barcodes.tsv.gz</span>
            <span class="va">features.tsv.gz</span>
            <span class="va">matrix.mtx.gz</span>
    <span class="va">sample2</span><span class="op">/</span>
        <span class="va">outs</span><span class="op">/</span><span class="va">filtered_feature_bc_matrix</span><span class="op">/</span>
            <span class="va">barcodes.tsv.gz</span>
            <span class="va">features.tsv.gz</span>
            <span class="va">matrix.mtx.gz</span>
<span class="va">.</span><span class="op">/</span><span class="va">otherCellRangerData</span><span class="op">/</span>
    <span class="va">barcodes.tsv</span>
    <span class="va">genes.tsv</span>
    <span class="va">matrix.mtx</span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Default use case</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importCellRanger.html">importCellRanger</a></span><span class="op">(</span>cellRangerDirs <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span>
<span class="co"># In case the three files are placed in a different way</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importCellRanger.html">importCellRanger</a></span><span class="op">(</span>sampleDirs <span class="op">=</span> <span class="st">"otherCellRangerData"</span>,
                        cellRangerOuts <span class="op">=</span> <span class="st">""</span>,
                        barcodesFileNames <span class="op">=</span> <span class="st">"barcodes.tsv"</span>,
                        featuresFileNames <span class="op">=</span> <span class="st">"genes.tsv"</span>,
                        matrixFileNames <span class="op">=</span> <span class="st">"matrix.mtx"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="quality-control-qc">Quality Control (QC)<a class="anchor" aria-label="anchor" href="#quality-control-qc"></a>
</h2>
<div class="section level3">
<h3 id="running-qc-methods">Running QC methods<a class="anchor" aria-label="anchor" href="#running-qc-methods"></a>
</h3>
<p>Quality control and filtering of cells is often needed before down-stream analyses such as dimensionality reduction and clustering. Typical filtering procedures include exclusion of poor quality cells with low numbers of counts/UMIs, estimation and removal of ambient RNA, and identification of potential doublet/multiplets. Many tools and packages are available to perform these operations and users are free to apply their tool(s) of choice.</p>
<p>To perform QC, we suggest using the <code><a href="../reference/runCellQC.html">runCellQC()</a></code> function. This is a wrapper for several methods for calculation of QC metrics, doublet detection, and estimation of ambient RNA. Below is a quick example of how to perform standard QC before heading to downstream analyses. If you have another preferred approach or your data has already been QC’ed, you can move to <a href="#variable-feature-selection">Feature Selection section</a>. For this tutorial, we will only run one doublet detection algorithm (<a href="https://bioconductor.org/packages/release/bioc/html/scDblFinder.html" class="external-link">scDblFinder</a>) and one decontamination algorithm (<a href="https://rdrr.io/bioc/celda/man/decontX.html" class="external-link">decontX</a>). For a full list of algorithms that this function runs by default, see <code><a href="../reference/runCellQC.html">?runCellQC</a></code>. We will also quantify the percentage of mitochondrial genes in each cell as this is often used as a measure of cell viability.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get list of mitochondrial genes</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importMitoGeneSet.html">importMitoGeneSet</a></span><span class="op">(</span><span class="va">sce</span>, reference <span class="op">=</span> <span class="st">"human"</span>, id <span class="op">=</span> <span class="st">"symbol"</span>,
                         by <span class="op">=</span> <span class="st">"rownames"</span>, collectionName <span class="op">=</span> <span class="st">"mito"</span><span class="op">)</span>
<span class="co"># Run QC</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runCellQC.html">runCellQC</a></span><span class="op">(</span><span class="va">sce</span>, sample <span class="op">=</span> <span class="cn">NULL</span>,
                 algorithms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"QCMetrics"</span>, <span class="st">"scDblFinder"</span>, <span class="st">"decontX"</span><span class="op">)</span>,
                 collectionName <span class="op">=</span> <span class="st">"mito"</span>,
                 geneSetListLocation <span class="op">=</span> <span class="st">"rownames"</span><span class="op">)</span>

<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getUMAP.html">getUMAP</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span>, reducedDimName <span class="op">=</span> <span class="st">"QC_UMAP"</span>, seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> If you have cells from multiple samples stored in the SCE object, make sure to supply the sample parameter as the QC tools need to be applied to cells from each sample individually.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="visualization">Visualization<a class="anchor" aria-label="anchor" href="#visualization"></a>
</h3>
<p>Individual sets of QC metrics can be plotted with specific functions. For example to plot distributions of total numbers of UMIs derived from <code><a href="../reference/runPerCellQC.html">runPerCellQC()</a></code>, doublet scores from <code><a href="../reference/runScDblFinder.html">runScDblFinder()</a></code>, and contamination scores from <code><a href="../reference/runDecontX.html">runDecontX()</a></code> (all of which were run by the <code><a href="../reference/runCellQC.html">runCellQC()</a></code> function), the following plotting functions can be used:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotRunPerCellQCResults.html">plotRunPerCellQCResults</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/plotPerCellQC-1.png" width="768"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotScDblFinderResults.html">plotScDblFinderResults</a></span><span class="op">(</span><span class="va">sce</span>, reducedDimName <span class="op">=</span> <span class="st">"QC_UMAP"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/plotScDblFinder-1.png" width="768"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotDecontXResults.html">plotDecontXResults</a></span><span class="op">(</span><span class="va">sce</span>, reducedDimName <span class="op">=</span> <span class="st">"QC_UMAP"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/plottDecontX-1.png" width="768"></p>
<p>A comprehensive HTML report can be generated to visualize and explore the QC metrics in greater detail:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/reportCellQC.html">reportCellQC</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="filtering">Filtering<a class="anchor" aria-label="anchor" href="#filtering"></a>
</h3>
<p>After examining the distributions of various QC metrics, poor quality cells will need to be removed. Typically, thresholds for QC metrics should exclude cells that are outliers of the distribution (i.e. long tails in the violin or density plots). Cells can be removed using the <code><a href="../reference/subsetSCECols.html">subsetSCECols()</a></code> function. Metrics stored in the <code>colData</code> slot of the SCE object can be filtered using the <code>colData</code> parameter. Here we will limit to cells with at least 600 counts and 300 genes detected, doublet score no more than 0.9, and at most 5% of mitochondrial genes detected:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subsetSCECols.html">subsetSCECols</a></span><span class="op">(</span><span class="va">sce</span>, colData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"total &gt; 600"</span>, <span class="st">"detected &gt; 300"</span>,
                                      <span class="st">"scDblFinder_doublet_score &lt; 0.8"</span>,
                                      <span class="st">"mito_percent &lt; 5"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># See number of cells after filtering</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 2528</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="normalization">Normalization<a class="anchor" aria-label="anchor" href="#normalization"></a>
</h2>
<p>After removing cells of low quality, we next need to normalize the feature expression matrix. SCTK has a generic wrapper function for various types of normalization, called <code><a href="../reference/runNormalization.html">runNormalization()</a></code>. In this tutorial, we apply a global-scaling normalization method from <a href="https://bioconductor.org/packages/release/bioc/html/scater.html" class="external-link">scater</a>, <code>"logNormCounts"</code>. It normalizes the feature expression for each cell by the total expression, multiplies this by a scale factor, and log-transforms the result. Afterwards, we recommend running a z-score scaling on the log-normalized matrix prior to dimensionality reduction.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runNormalization.html">runNormalization</a></span><span class="op">(</span><span class="va">sce</span>, useAssay <span class="op">=</span> <span class="st">"counts"</span>, outAssayName <span class="op">=</span> <span class="st">"logcounts"</span>,
                        normalizationMethod <span class="op">=</span> <span class="st">"logNormCounts"</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runNormalization.html">runNormalization</a></span><span class="op">(</span><span class="va">sce</span>, useAssay <span class="op">=</span> <span class="st">"logcounts"</span>,
                        outAssayName <span class="op">=</span> <span class="st">"logcounts_scaled"</span>, scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<blockquote>
<p>SCTK also supports a number of batch correction methods. Here we don’t present the workflow because PBMC3k dataset only has one batch. For examples, please refer to the <a href="batch_correction.html">document of batch correction</a>.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="variable-feature-selection">Variable Feature Selection<a class="anchor" aria-label="anchor" href="#variable-feature-selection"></a>
</h2>
<p>Selecting highly variable genes (HVG) for downstream analyses is recommended, since a subset of variable features can speed up the computation and reduce the noise being introduced. SCTK wraps the methods used in <a href="https://satijalab.org/seurat/" class="external-link">Seurat</a> and <a href="https://bioconductor.org/packages/release/bioc/html/scran.html" class="external-link">Scran</a>. We recommend keeping at least 2,000-5,000 HVGs. In the example code, we use the “VST” method from Seurat, and select the top 2,000 genes.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSeuratFindHVG.html">runSeuratFindHVG</a></span><span class="op">(</span><span class="va">sce</span>, useAssay <span class="op">=</span> <span class="st">"counts"</span>, hvgMethod <span class="op">=</span> <span class="st">"vst"</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getTopHVG.html">getTopHVG</a></span><span class="op">(</span><span class="va">sce</span>, method <span class="op">=</span> <span class="st">"vst"</span>, n <span class="op">=</span> <span class="fl">2000</span>, altExp <span class="op">=</span> <span class="st">"hvg"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotTopHVG.html">plotTopHVG</a></span><span class="op">(</span><span class="va">sce</span>, method <span class="op">=</span> <span class="st">"vst"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/hvg-1.png" width="700"></p>
<blockquote>
<p><strong>Note:</strong> The row-subsetted matrix is stored in the “alternative experiment” slot (<code>altExp</code>) within the SCE object. This allows for a matrix with a different number of rows to be stored within the same SCE object (rather than creating two SCE objects). Some of the SCTK functions described in the next several sections will operate on a matrix stored in the <code>altExp</code> slot. The list of alternative experiments in an SCE can be view with <code>altExpNames(sce)</code>. In the future, there will be update to utilize the <a href="https://bioconductor.org/packages/release/bioc/html/ExperimentSubset.html" class="external-link">ExperimentSubset</a> package for simpler operation on the subsets.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="linear-dimension-reduction">Linear Dimension Reduction<a class="anchor" aria-label="anchor" href="#linear-dimension-reduction"></a>
</h2>
<p>Although we have selected variable features, we would like to further reduce the noise. The next step is performing a principal component analysis (PCA), which creates new uncorrelated variables that successively maximize variance and finally increases the data interpretability but at the same time minimizes the information loss.</p>
<p>In this tutorial, we use the wrapper function <code><a href="../reference/scaterPCA.html">scaterPCA()</a></code>, which comes from Scater. This function allows users to directly use a full-sized feature expression assay, as well as a subsetted expression matrix. Here, we will use the HVG selected in the last section and feed it to <code>useAltExp</code> argument.</p>
<p>SCTK also supports Seurat’s PCA and ICA method, which do a similar job. For Seurat methods, please refer to our <a href="cnsl_seurat_curated_workflow.html">Seurat Curated Workflow</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runDimReduce.html">runDimReduce</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span>, method <span class="op">=</span> <span class="st">"scaterPCA"</span>, 
                    useAssay <span class="op">=</span> <span class="st">"logcounts_scaled"</span>, useAltExp <span class="op">=</span> <span class="st">"hvg"</span>,
                    reducedDimName <span class="op">=</span> <span class="st">"PCA"</span>, seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotDimRed.html">plotDimRed</a></span><span class="op">(</span><span class="va">sce</span>, useReduction <span class="op">=</span> <span class="st">"PCA"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/pca-1.png" width="700"></p>
<blockquote>
<p>Note: When using <code>useAltExp</code> argument in SCTK functions, users should also be aware of the <code>useAssay</code> argument. Usually when both are available, using only <code>useAssay</code> means using a full-sized feature expression matrix; using <code>useAssay</code> and <code>useAltExp</code> in the same call means using a subsetted expression matrix. In the latter scenario, <code>useAltExp</code> points to the alternative experiment stored in <code>altExp</code> slot of the SCE object, and <code>useAssay</code> points to the <code>assay</code> slot in the alternative experiment object.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="clustering">Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h2>
<div class="section level3">
<h3 id="running-snn-graph-based-clustering">Running SNN graph based clustering<a class="anchor" aria-label="anchor" href="#running-snn-graph-based-clustering"></a>
</h3>
<p>SCTK supports clustering cells with Shared Nearest Neighbors (SNN) graph based methods and K-Means algorithm. For SNN graph based methods, we wrap the graph constructor from <code>scran</code> library, and have options of algorithms from <code>igraph</code> that can perform clustering on the graph. The result of clustering will be stored in the <code>colData</code> slot with variable name set by <code>clusterName</code>.</p>
<p>Similarly as the steps above, <code><a href="../reference/runScranSNN.html">runScranSNN()</a></code> allows various types of input matrix, including log-normalized a full sized feature expression matrix or a subset of it, as well as a dimension reduction matrix. In this tutorial, we will use the PCA embedding generated in the previous section.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runScranSNN.html">runScranSNN</a></span><span class="op">(</span><span class="va">sce</span>, useReducedDim <span class="op">=</span> <span class="st">"PCA"</span>, clusterName <span class="op">=</span> <span class="st">"cluster"</span>, algorithm <span class="op">=</span> <span class="st">"louvain"</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p>Meanwhile, in the Seurat Curated Workflow, the clustering is also done with an SNN graph, but the wrapper function alone, <code><a href="../reference/runSeuratFindClusters.html">runSeuratFindClusters()</a></code>, would be hard to use out of the curated workflow.</p>
<p>In the other curated workflow that SCTK wraps, Celda Curated Workflow, we use a Bayesian hierarchical model that can bi-cluster features into modules and observations into subpopulations. For detail of this method, please refer to the <a href="https://celda.camplab.net" class="external-link">Celda Documentation</a>.</p>
</div>
<div class="section level3">
<h3 id="visualization-with-umap">Visualization with UMAP<a class="anchor" aria-label="anchor" href="#visualization-with-umap"></a>
</h3>
<p>Uniform Manifold Approximation and Projection (UMAP) is one of the most commonly used methods to visualize the relationships between the cells in a 2-D embedding. This can be done using the function <code><a href="../reference/getUMAP.html">getUMAP()</a></code>, which is a wrapper of <code><a href="https://rdrr.io/pkg/scater/man/runUMAP.html" class="external-link">scater::calculateUMAP()</a></code> method. The result will be saved in <code>reducedDim</code> slot.</p>
<p>Following the steps above, we will now use <code>useReducedDim</code> argument to pass the PCA embedding just generated to the function. This wrapper function also allows <code>useAssay</code> or <code>useAltExp</code> + <code>useAssay</code> method, while providing an option of running PCA dimension reduction on the expression matrix prior to the UMAP computation. In this way, however, the PCA will be done by <code>scater</code>, thus cannot be customized.</p>
<p>SCTK also has the function for t-distributed Stochastic Neighbor Embedding (tSNE) method to create 2-D embedding for visualization, <code><a href="../reference/getTSNE.html">getTSNE()</a></code>, where the general arguments for inputting a matrix work in the similar way.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runDimReduce.html">runDimReduce</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span>, method <span class="op">=</span> <span class="st">"scaterUMAP"</span>, useReducedDim <span class="op">=</span> <span class="st">"PCA"</span>, reducedDimName <span class="op">=</span> <span class="st">"UMAP"</span>, seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/plotSCEDimReduceColData.html">plotSCEDimReduceColData()</a></code> is a generic plotting function that use the values stored in <code>reducedDim</code> slot as the axis to make 2-D scatter plots, and use the variables stored in <code>colData</code> slot to label each cell, by colors or shapes.</p>
<p>Now, with the clustering result labeled for each cell and stored in the <code>colData</code> slot. We can plot the UMAP generated previously, with the clustering result labeled.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotSCEDimReduceColData.html">plotSCEDimReduceColData</a></span><span class="op">(</span><span class="va">sce</span>, colorBy <span class="op">=</span> <span class="st">"cluster"</span>, reducedDimName <span class="op">=</span> <span class="st">"UMAP"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/cluster_umap-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="marker-detection-and-differential-expression">Marker Detection And Differential Expression<a class="anchor" aria-label="anchor" href="#marker-detection-and-differential-expression"></a>
</h2>
<div class="section level3">
<h3 id="marker-detection">Marker Detection<a class="anchor" aria-label="anchor" href="#marker-detection"></a>
</h3>
<p>Users can next perform marker detection process with clusters labeled, or any other types of reasonable grouping of similar biological state of cells annotated in <code>colData</code> slot. SCTK finds markers for each cluster by running DE analysis on one cluster against all other clusters and iterating the same process for each cluster.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findMarkerDiffExp.html">findMarkerDiffExp</a></span><span class="op">(</span><span class="va">sce</span>, useAssay <span class="op">=</span> <span class="st">"logcounts"</span>, method <span class="op">=</span> <span class="st">"wilcox"</span>,
                         cluster <span class="op">=</span> <span class="st">"cluster"</span>,
                         log2fcThreshold <span class="op">=</span> <span class="fl">0</span>, fdrThreshold <span class="op">=</span> <span class="fl">0.05</span>,
                         minClustExprPerc <span class="op">=</span> <span class="fl">0</span>, maxCtrlExprPerc <span class="op">=</span> <span class="fl">1</span>,
                         minMeanExpr <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>By running <code><a href="../reference/findMarkerDiffExp.html">findMarkerDiffExp()</a></code>, SCTK stores a <code>data.table</code> of marker table to the <code>matadata</code> slot of the SCE object. The marker table will include all detected markers for each cluster and statistical values associated to each marker. To fetch the table, users can use the command below, and even add filtering parameters.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">topMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findMarkerTopTable.html">findMarkerTopTable</a></span><span class="op">(</span><span class="va">sce</span>, topN <span class="op">=</span> <span class="fl">1</span>, log2fcThreshold <span class="op">=</span> <span class="fl">0</span>, fdrThreshold <span class="op">=</span> <span class="fl">0.05</span>,
                                 minClustExprPerc <span class="op">=</span> <span class="fl">0.5</span>, maxCtrlExprPerc <span class="op">=</span> <span class="fl">0.4</span>,
                                 minMeanExpr <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">topMarkers</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##          Gene   Log2_FC        Pvalue           FDR cluster clusterExprPerc</span>
<span class="co">## 19802    CD3D 0.8552090  1.036505e-82  9.980320e-80       1       0.8590705</span>
<span class="co">## 30657   CD79A 2.2762371 3.177726e-145 2.600810e-141       2       0.9337349</span>
<span class="co">## 87641    IL7R 0.6529081  7.313849e-38  1.995340e-34       3       0.7164835</span>
<span class="co">## 1956   S100A9 4.3355126 1.136289e-197 1.859991e-193       4       0.9952941</span>
<span class="co">## 31076    NKG7 4.2560640  1.788630e-76  5.855618e-72       5       1.0000000</span>
<span class="co">## 268251   CCL5 3.0025318 8.740971e-111 2.861619e-106       6       0.9702602</span>
<span class="co">## 106091   LST1 2.8570975  1.057570e-91  1.154091e-87       7       1.0000000</span>
<span class="co">## 288182   CST3 3.2687915  1.247754e-14  6.808163e-11       8       1.0000000</span>
<span class="co">## 7697     PPBP 5.6247915  2.841503e-07  1.621470e-03       9       1.0000000</span>
<span class="co">## 83561   HMGB2 2.3854520  3.434666e-05  3.407397e-02      10       0.8888889</span>
<span class="co">##        ControlExprPerc clusterAveExpr</span>
<span class="co">## 19802       0.38850081       1.562329</span>
<span class="co">## 30657       0.04098361       2.317671</span>
<span class="co">## 87641       0.32657984       1.146453</span>
<span class="co">## 1956        0.22586781       4.671252</span>
<span class="co">## 31076       0.25010491       4.793217</span>
<span class="co">## 268251      0.22930500       3.449170</span>
<span class="co">## 106091      0.29987185       3.438184</span>
<span class="co">## 288182      0.38815526       4.335429</span>
<span class="co">## 7697        0.02382844       5.651197</span>
<span class="co">## 83561       0.31480746       2.765561</span></code></pre>
<p>For visualization, SCTK has a specific heatmap plotting function for detected markers. The heatmap will take the log-normalized feature expression matrix for the values, and subset the features to only the top markers of each cluster. For the organization of the heatmap, the function groups the markers by the belonging to the clusters, and groups the cells, obviously, by clusters. Inside the grouping, the function finally performs the default hierarchical clustering.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotMarkerDiffExp.html">plotMarkerDiffExp</a></span><span class="op">(</span><span class="va">sce</span>, topN <span class="op">=</span> <span class="fl">5</span>, log2fcThreshold <span class="op">=</span> <span class="fl">0</span>, 
                  fdrThreshold <span class="op">=</span> <span class="fl">0.05</span>, minClustExprPerc <span class="op">=</span> <span class="fl">0.5</span>, 
                  maxCtrlExprPerc <span class="op">=</span> <span class="fl">0.4</span>, minMeanExpr <span class="op">=</span> <span class="fl">0</span>, 
                  rowLabel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/markerHeatmap-1.png" width="864"></p>
</div>
<div class="section level3">
<h3 id="customized-differential-expression-analysis">Customized Differential Expression Analysis<a class="anchor" aria-label="anchor" href="#customized-differential-expression-analysis"></a>
</h3>
<p>As we can easily tell from the heatmap above, “cluster 1” and “cluster 3” are having a very similar expression profile across the top markers detected. In order to further explore the difference between these two clusters, or any other two reasonable groups of cells, user can use the function <code><a href="../reference/runDEAnalysis.html">runDEAnalysis()</a></code>.</p>
<p><code><a href="../reference/runDEAnalysis.html">runDEAnalysis()</a></code> is a generic function for performing differential expression (DE) analysis between two selected groups of cells. This is also used by <code><a href="../reference/findMarkerDiffExp.html">findMarkerDiffExp()</a></code>. By running DE analysis, the function will take the normalized read count data and perform statistical analysis to discover quantitative changes in expression levels between selected groups. See here for the detail of <a href="differential_expression.html">running DE analysis with SCTK</a>.</p>
<p>There are multiple ways to specify the groups of cells to be compared: by either directly specifying indices of cells, or selecting groups of cells with a categorical variable in <code>colData</code>. Additionally, <code><a href="../reference/runDEAnalysis.html">runDEAnalysis()</a></code> requires a relatively sophisticated inputs for naming the analyses, including the names of the two groups, and the name of one analysis, though these are not necessary for calling the algorithms alone. By requiring these, the results of the analyses can be stored with human readable identifiers and within one single SCE object, and can be more manageable. See the <a href="differential_expression.html">DE documentation</a> for the detail.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runDEAnalysis.html">runDEAnalysis</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span>, method <span class="op">=</span> <span class="st">"wilcox"</span>, useAssay <span class="op">=</span> <span class="st">"logcounts"</span>,
                     class <span class="op">=</span> <span class="st">"cluster"</span>, classGroup1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, classGroup2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>,
                     groupName1 <span class="op">=</span> <span class="st">"cluster1"</span>, groupName2 <span class="op">=</span> <span class="st">"cluster3"</span>, 
                     analysisName <span class="op">=</span> <span class="st">"cluster1_VS_3"</span><span class="op">)</span></code></pre></div>
<p>Similarly to the marker detection section, SCTK also has a DE analysis specific heatmap plotting function, <code><a href="../reference/plotDEGHeatmap.html">plotDEGHeatmap()</a></code>. Here, users can just easily enter the <code>analysisName</code> specified for one run and the function will automatically arrange the output. The heatmap is also splitted into a “checker board”, by the “conditions” (i.e. the groups selected when running <code><a href="../reference/runDEAnalysis.html">runDEAnalysis()</a></code>) and the “regulation” (i.e. “up” if the log2 fold change is positive in “group1” against “group2”).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotDEGHeatmap.html">plotDEGHeatmap</a></span><span class="op">(</span><span class="va">sce</span>, useResult <span class="op">=</span> <span class="st">"cluster1_VS_3"</span>, rowLabel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/deHeatmap-1.png" width="700"></p>
<p>Additionally, the input matrix for DE analysis can be specified with either <code>useAssay</code> or <code>useReducedDim</code>. When one of them is specified, the other has to be <code>NULL</code>, to avoid ambiguity. For example, when users perform a pathway analysis and get a score matrix stored in <code>reducedDims</code> slot, DE analysis can be performed on this score matrix. See <a href="#performing-de-analysis-on-pathway-analysis-scores">example</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="cell-type-labeling">Cell Type Labeling<a class="anchor" aria-label="anchor" href="#cell-type-labeling"></a>
</h2>
<p>SCTK adopts <a href="https://bioconductor.org/packages/release/bioc/html/SingleR.html" class="external-link">SingleR</a> method for labeling the cell types, and wraps the function in <code><a href="../reference/runSingleR.html">runSingleR()</a></code>. Briefly, it labels each cell (or cluster) in users’ datasets basing on similarity to a reference datasets. SingleR has recommended some datasets, so we enable choosing abbreviation name of them in argument <code>useBltinRef</code>. Please click on the function name for usage detail.</p>
<blockquote>
<p>Note: Choosing a reference from the recommended builtin references would also require some prior knowledge of user data. <strong>Users should choose a reference that covers the cell types possibly exist in user dataset.</strong> SingleR works by scoring the similarity to each cell type and assigning a cell type by the highest score, regardless of how low the score is. Thus a beta cell from pancrea data cound even be wrongly labeled as a platelet if using a blood cell reference.</p>
</blockquote>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSingleR.html">runSingleR</a></span><span class="op">(</span><span class="va">sce</span>, useAssay <span class="op">=</span> <span class="st">"logcounts"</span>, level <span class="op">=</span> <span class="st">"fine"</span><span class="op">)</span></code></pre></div>
<p>The result of labeling will again be saved to <code>colData</code> slot of the SCE object. There will be multiple types of information being stored, including a scoring matrix named by <code>"SingleR_{ref}_{level}_scores"</code>, where <code>{ref}</code> refers to the reference selected, <code>{level}</code> refers to the <code>level</code> argument being passed to the function. And three <code>"SingleR_{ref}_{level}_{typeOfLabels}"</code> columns, where <code>{typeOfLabels}</code> includes <code>first.labels</code>, <code>labels</code>, <code>pruned.labels</code>. For the difference, please refer to <code><a href="https://rdrr.io/pkg/SingleR/man/classifySingleR.html" class="external-link">?SingleR::classifySingleR</a></code>.</p>
<p>We can also plot the labeling on to the UMAP we got previously.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotSCEDimReduceColData.html">plotSCEDimReduceColData</a></span><span class="op">(</span><span class="va">sce</span>, colorBy <span class="op">=</span> <span class="st">"SingleR_hpca_fine_pruned.labels"</span>,
                        reducedDimName <span class="op">=</span> <span class="st">"UMAP"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/singleRUMAP-1.png" width="1152"></p>
</div>
<div class="section level2">
<h2 id="differential-abundance">Differential Abundance<a class="anchor" aria-label="anchor" href="#differential-abundance"></a>
</h2>
<p>The goal of the differential abundance analysis is to determine if categorical variables such as phenotype or sample (e.g. treatment or control) are enriched in different cell clusters using the Fisher’s exact test (FET). Any categorical variables in <code>colData(sce)</code> can be used by passing the variable name to argument <code>cluster</code> or <code>variable</code>. Categories in the phenotype variable (used for <code>variable</code>) can be passed to <code>case</code> or <code>control</code>. For this example, we try to examine whether there are any <a href="#clustering">cell clusters</a> enriched in an annotated cell type <a href="#cell-type-labeling">using SingleR</a>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Returns a vector where TRUE for a type of NK cell</span>
<span class="va">isNKCell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">SingleR_hpca_fine_pruned.labels</span>, <span class="st">"NK_cell"</span><span class="op">)</span>
<span class="co"># Returns a vector where TRUE for a type of T cell</span>
<span class="va">isTCell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">startsWith</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">SingleR_hpca_fine_pruned.labels</span>, <span class="st">"T_cell"</span><span class="op">)</span>
<span class="co"># Make up a variable with only categories of "NK_cell", "T_cell" and "Other".</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">cell_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">isNKCell</span>, <span class="st">"NK_cell"</span>, <span class="st">"Other"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">cell_type</span><span class="op">[</span><span class="va">isTCell</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"T_cell"</span>
<span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">cell_type</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Other"</span>
<span class="co"># Run differential abundance test</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/diffAbundanceFET.html">diffAbundanceFET</a></span><span class="op">(</span><span class="va">sce</span>, cluster <span class="op">=</span> <span class="st">"cluster"</span>, 
                        variable <span class="op">=</span> <span class="st">"cell_type"</span>, 
                        case <span class="op">=</span> <span class="st">"NK_cell"</span>, control <span class="op">=</span> <span class="st">"T_cell"</span>,
                        analysisName <span class="op">=</span> <span class="st">"NK_VS_T"</span><span class="op">)</span></code></pre></div>
<p>Users can get the table of result with the method below, using the <code>analysisName</code> specified when running the analysis.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getDiffAbundanceResults.html">getDiffAbundanceResults</a></span><span class="op">(</span><span class="va">sce</span>, analysisName <span class="op">=</span> <span class="st">"NK_VS_T"</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="2%">
<col width="10%">
<col width="11%">
<col width="10%">
<col width="11%">
<col width="10%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="2%">
<col width="2%">
<col width="2%">
</colgroup>
<thead><tr class="header">
<th align="left">Cluster</th>
<th align="left">Number of cells in cluster and in T_cell</th>
<th align="left">Number of cells NOT in cluster and in T_cell</th>
<th align="left">Number of cells in cluster and in NK_cell</th>
<th align="left">Number of cells NOT in cluster and in NK_cell</th>
<th align="left">Fraction of cells in cluster and in T_cell</th>
<th align="left">Fraction of cells NOT in cluster and in T_cell</th>
<th align="left">Fraction of cells in cluster and in NK_cell</th>
<th align="left">Fraction of cells NOT in cluster and in NK_cell</th>
<th align="left">Odds_Ratio</th>
<th align="left">Pvalue</th>
<th align="left">FDR</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">653</td>
<td align="left">722</td>
<td align="left">1</td>
<td align="left">148</td>
<td align="left">0.474909</td>
<td align="left">0.525</td>
<td align="left">0.00671</td>
<td align="left">0.993</td>
<td align="left">1.34e+02</td>
<td align="left">2.74e-37</td>
<td align="left">1.37e-36</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">1</td>
<td align="left">1374</td>
<td align="left">0</td>
<td align="left">149</td>
<td align="left">0.000727</td>
<td align="left">0.999</td>
<td align="left">0.00000</td>
<td align="left">1.000</td>
<td align="left">Inf</td>
<td align="left">1.00e+00</td>
<td align="left">1.00e+00</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">452</td>
<td align="left">923</td>
<td align="left">0</td>
<td align="left">149</td>
<td align="left">0.328727</td>
<td align="left">0.671</td>
<td align="left">0.00000</td>
<td align="left">1.000</td>
<td align="left">Inf</td>
<td align="left">1.10e-24</td>
<td align="left">3.65e-24</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">0</td>
<td align="left">1375</td>
<td align="left">0</td>
<td align="left">149</td>
<td align="left">0.000000</td>
<td align="left">1.000</td>
<td align="left">0.00000</td>
<td align="left">1.000</td>
<td align="left">0.00e+00</td>
<td align="left">1.00e+00</td>
<td align="left">1.00e+00</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">22</td>
<td align="left">1353</td>
<td align="left">122</td>
<td align="left">27</td>
<td align="left">0.016000</td>
<td align="left">0.984</td>
<td align="left">0.81879</td>
<td align="left">0.181</td>
<td align="left">3.68e-03</td>
<td align="left">7.85e-129</td>
<td align="left">7.85e-128</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">243</td>
<td align="left">1132</td>
<td align="left">24</td>
<td align="left">125</td>
<td align="left">0.176727</td>
<td align="left">0.823</td>
<td align="left">0.16107</td>
<td align="left">0.839</td>
<td align="left">1.12e+00</td>
<td align="left">7.34e-01</td>
<td align="left">1.00e+00</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="left">0</td>
<td align="left">1375</td>
<td align="left">0</td>
<td align="left">149</td>
<td align="left">0.000000</td>
<td align="left">1.000</td>
<td align="left">0.00000</td>
<td align="left">1.000</td>
<td align="left">0.00e+00</td>
<td align="left">1.00e+00</td>
<td align="left">1.00e+00</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="left">0</td>
<td align="left">1375</td>
<td align="left">0</td>
<td align="left">149</td>
<td align="left">0.000000</td>
<td align="left">1.000</td>
<td align="left">0.00000</td>
<td align="left">1.000</td>
<td align="left">0.00e+00</td>
<td align="left">1.00e+00</td>
<td align="left">1.00e+00</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="left">0</td>
<td align="left">1375</td>
<td align="left">0</td>
<td align="left">149</td>
<td align="left">0.000000</td>
<td align="left">1.000</td>
<td align="left">0.00000</td>
<td align="left">1.000</td>
<td align="left">0.00e+00</td>
<td align="left">1.00e+00</td>
<td align="left">1.00e+00</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="left">4</td>
<td align="left">1371</td>
<td align="left">2</td>
<td align="left">147</td>
<td align="left">0.002909</td>
<td align="left">0.997</td>
<td align="left">0.01342</td>
<td align="left">0.987</td>
<td align="left">2.15e-01</td>
<td align="left">1.10e-01</td>
<td align="left">2.74e-01</td>
</tr>
</tbody>
</table>
<p>Alternatively, users can choose to directly make a plot using the two variables and the function <code><a href="../reference/plotClusterAbundance.html">plotClusterAbundance()</a></code> will automatically calculate the statistic and visualize the result. The proportion or count of each category in each cluster will be displayed in stacked bar plots:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotClusterAbundance.html">plotClusterAbundance</a></span><span class="op">(</span><span class="va">sce</span>, cluster <span class="op">=</span> <span class="st">"cluster"</span>, variable <span class="op">=</span> <span class="st">"cell_type"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/plotClusterAbundance-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="pathway-analysis">Pathway Analysis<a class="anchor" aria-label="anchor" href="#pathway-analysis"></a>
</h2>
<p>For the purpose of gene set enrichment (GSE) analysis, SCTK imports VAM and GSVA as options. Both of them work by loading some user-defined gene sets (<a href="import_genesets.html">more about loading gene sets</a>), and calculating the enrichment score of each gene set in each cell. Here we will go through calling VAM to inspect the enrichment of the hallmark gene sets available in <a href="https://www.gsea-msigdb.org/gsea/msigdb/" class="external-link">MSigDB database</a>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importGeneSetsFromMSigDB.html">importGeneSetsFromMSigDB</a></span><span class="op">(</span><span class="va">sce</span>, categoryIDs <span class="op">=</span> <span class="st">"H"</span>, species <span class="op">=</span> <span class="st">"Homo sapiens"</span><span class="op">)</span>
<span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runVAM.html">runVAM</a></span><span class="op">(</span><span class="va">sce</span>, geneSetCollectionName <span class="op">=</span> <span class="st">"H"</span>, useAssay <span class="op">=</span> <span class="st">"logcounts"</span><span class="op">)</span></code></pre></div>
<p>To visualize the result, we simply adopt a violin plot to show the distribution of the CDF scores of the cells, which can be, optionally, grouped by the cluster labels.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hallmark</span> <span class="op">&lt;-</span> <span class="st">"HALLMARK_INFLAMMATORY_RESPONSE"</span>
<span class="fu"><a href="../reference/plotPathway.html">plotPathway</a></span><span class="op">(</span><span class="va">sce</span>, resultName <span class="op">=</span> <span class="st">"VAM_H_CDF"</span>, geneset <span class="op">=</span> <span class="va">hallmark</span>, groupBy <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/visVAM-1.png" width="700"></p>
<p>Note that available options for argument <code>resultName</code> and <code>geneset</code> can be printed with getter functions below.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getPathwayResultNames.html">getPathwayResultNames</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span><span class="op">)</span>
<span class="fu"><a href="../reference/getGenesetNamesFromCollection.html">getGenesetNamesFromCollection</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span>, geneSetCollectionName <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span></code></pre></div>
<blockquote>
<p>Note: In the current version of SCTK, the returned score matrices from either VAM or GSVA are stored in the <code>reducedDims</code> slot, since the feature dimensions are for the gene sets instead of the genes or subsets of genes. In the future, SCTK will adopt other types of data container for simpler operation on different types of feature sets.</p>
</blockquote>
<div class="section level3">
<h3 id="performing-de-analysis-on-pathway-analysis-scores">Performing DE Analysis on Pathway Analysis Scores<a class="anchor" aria-label="anchor" href="#performing-de-analysis-on-pathway-analysis-scores"></a>
</h3>
<p>SCTK allows users to select the score matrix from pathway analysis to perform differential expression analysis. In this process, each geneset will be treated as the feature/gene, and comparison groups can still be set in the same way as introduced in <a href="#customized-differential-expression-analysis">DE analysis section</a>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runDEAnalysis.html">runDEAnalysis</a></span><span class="op">(</span>inSCE <span class="op">=</span> <span class="va">sce</span>, method <span class="op">=</span> <span class="st">"wilcox"</span>, 
                     useAssay <span class="op">=</span> <span class="cn">NULL</span>, useReducedDim <span class="op">=</span> <span class="st">"VAM_H_CDF"</span>,
                     class <span class="op">=</span> <span class="st">"cluster"</span>, classGroup1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, classGroup2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>,
                     groupName1 <span class="op">=</span> <span class="st">"T_cells"</span>, groupName2 <span class="op">=</span> <span class="st">"monocytes"</span>, 
                     analysisName <span class="op">=</span> <span class="st">"T_cells_VS_monocytes_VAM_H_CDF"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotDEGHeatmap.html">plotDEGHeatmap</a></span><span class="op">(</span><span class="va">sce</span>, useResult <span class="op">=</span> <span class="st">"T_cells_VS_monocytes_VAM_H_CDF"</span>, 
               rowLabel <span class="op">=</span> <span class="cn">TRUE</span>, rowTitle <span class="op">=</span> <span class="st">"Geneset"</span><span class="op">)</span></code></pre></div>
<p><img src="console_analysis_tutorial_files/figure-html/pathwayDE-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yichen Wang, Irzam Sarfraz, Rui Hong, Yusuke Koga, Salam Alabdullatif, David Jenkins, Vidya Akavoor, Xinyun Cao, Shruthi Bandyadka, Anastasia Leshchyk, Tyler Faits, Mohammed Muzamil Khan, Zhe Wang, W. Evan Johnson, Joshua David Campbell.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
