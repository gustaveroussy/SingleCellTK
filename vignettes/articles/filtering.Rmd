---
title: "Filtering the datasets"
author: "Yichen Wang"
output:
  html_document:
    toc: true
    toc_depth: 5
bibliography: references.bib
csl: ieee.csl
---

```{r develSetting, include=FALSE}
doEval = FALSE
knitr::opts_chunk$set(warning = FALSE)
```

````{=html}
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
````

## Introduction

This section introduces how to filter the single-cell dataset after running QC metrics or apply subsetting basing on other types of criteria. 

## Workflow Guide

````{=html}
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'interactive')" id="ia-button">Interactive Analysis</button>
  <button class="tablinks" onclick="openTab(event, 'console')" id="console-button">Console Analysis</button>
</div>

<div id="interactive" class="tabcontent">
````

![entry](ui_screenshots/filtering/filter_ui_entry.png)\

Users should enter this section as instructed by the screenshot above.  

Here we will take the example PBMC3K dataset as an example. We imported this dataset through the **"Data" -> "Import Single Cell Data" tab**, by selecting **"Import example datasets"** first and using the default **"PBMC 3K (10X)"** option then. We next applied three QC methods: General QC metrics, DecontX, and scDblFinder, with all default parameters. Below we will have the plots as generated by SCTK.  

![egQC](ui_screenshots/filtering/filter_ui_egQC.png)\

**Adding Filters for Cells**

To filter by cells, users must click the "**Add a Filter**" button in the "**Select Cell Filtering Criteria**" panel. A pop-up will appear which asks users to select by which annotation to filter. Based on that selection, more input fields will appear for users to specify how they would like to set the filter.  
- If the annotation contains categorical information, mostly presented by text or TRUE/FALSE values, users will have to select which categories to keep;  
- If the annotation contains numeric values that might stand for categorical information, users will be asked whether to treat them as categories with a check-box "**Convert to categorical filter**". If users check this, users will have to select which categories to keep;  
- If users do not want to treat the category-like numeric values in the condition above, or the annotation contains true numeric values, users will have to set a valid range of value to keep. For keeping cells with the value greater than a threshold, check "**Greater than**" and input the number; for keeping cells with the value less than a threshold, check "**Less than**" and input the number. Users can also check both threshold for double ended range setting.  
After setting each criterion, users have to click on "**OK**" button to save it to the criterion table. Users can again press "**Add a Filter**" to add more criteria.  

![columns](ui_screenshots/filtering/filter_ui_column.png)\

**Adding Filters for features**

To filter by features, users must click the "**Add a Filter**" button in the "**Select Feature Filtering Criteria**" panel. A pop-up will appear which asks users to set the parameters to filter out features. Features are filtered by specifying at least how many counts a gene should be expressed in at least how many cells. Users must first select a expression matrix from the dropdown menu at top of the pop-up. Then, users have to input the numbers in the following numeric fields as explained. To save the the criterion, users must click "**OK**".  

![row](ui_screenshots/filtering/filter_ui_row.png)\

**Applying Filters**

Once users have defined all their filtering criteria, the user must click "Filter" to apply the filters to the single-cell dataset. 

![run](ui_screenshots/filtering/filter_ui_run.png)\

Finally, two tables of the data summary will appear at the bottom for comparing how the filtering works on the dataset.  

![result](ui_screenshots/filtering/filter_ui_result.png)\

````{=html}
</div>

<div id="console" class="tabcontent">
````

Single Cell Toolkit (singleCellTK, SCTK) uses [`SingleCellExperiment`](https://rdrr.io/bioc/SingleCellExperiment/man/SingleCellExperiment.html) (SCE) object as the basic container of users' datasets. Users can easily subset their SCE object with indices inside a suffix bracket. (e.g. `sce[1:10,]`) This documentation will skip this type of operation.  

SCTK provides functions that performs filtering/subsetting basing on `colData` or `rowData`, namingly `subsetSCECols()` or `subsetSCERows()`, respectively. Here we will show some examples.  

```{R subsetEG, eval=FALSE}
# Get an SCE object
library(singleCellTK)
sce <- importExampleData("pbmc3k")
sce <- runCellQC(sce, algorithms = "QCMetrics")
## Filter cells basing on multiple columns in `colData` at one time
sce <- subsetSCECols(sce, colData = c("sum < 10000", "detected < 2000"))
```

For the detail of the arguments, please click on the function name to see the reference page.  

Furthermore, in terms of subsetting the features, such as using a set of highly variable genes (HVG), SCTK tends to store a subsetted SCE object in the `altExp` slot of the main SCE object. For detail, please see [feature selection documentation](cnsl_feature_selection.html). Therefore, when using `subsetSCERows()`, we recommend turning the argument `returnAsAltExp` to `TRUE`.  

````{=html} 
</div>
<script>
document.getElementById("ia-button").click();
</script>
</body>
````
